# å†…å®¹ç”Ÿæˆ Code èŠ‚ç‚¹ä¿®æ”¹è¯´æ˜

## ğŸ“ ä¿®æ”¹æ¦‚è¦

å°†æ‚¨åŸæœ‰çš„è§£æä»£ç è°ƒæ•´ä¸ºé€‚åº”å¼‚æ­¥å¤„ç†æ¶æ„çš„ç‰ˆæœ¬ã€‚

---

## ğŸ”§ å…³é”®ä¿®æ”¹ç‚¹

### 1. æ·»åŠ  taskId è·å–é€»è¾‘

**æ–°å¢ä»£ç **ï¼ˆåœ¨æ–‡ä»¶å¼€å¤´ï¼‰:

```javascript
// ä»å‰é¢çš„èŠ‚ç‚¹è·å– taskId å’Œ createdAt
let taskId = null;
let createdAt = null;

// æ–¹æ³•1: ä» Update row(s)1 è·å–
try {
  const updateNode = $('Update row(s)1').first().json;
  taskId = updateNode.taskId;
  createdAt = updateNode.createdAt;
} catch (e) {
  // ç»§ç»­å°è¯•å…¶ä»–æ–¹æ³•
}

// æ–¹æ³•2ã€3: å¤‡ç”¨è·å–æ–¹å¼...

if (!taskId) {
  throw new Error('æ— æ³•è·å– taskId');
}
```

**ä½œç”¨**: ç¡®ä¿èƒ½æ­£ç¡®è·å–ä»»åŠ¡IDï¼Œç”¨äºåç»­çš„æ•°æ®åº“æ›´æ–°ã€‚

---

### 2. ä¿ç•™æ‚¨çš„ JSON è§£æé€»è¾‘

**ä¿ç•™åŸæœ‰ä»£ç **:

````javascript
// æ‚¨çš„æ™ºèƒ½ JSON æå–å‡½æ•°
function extractJSON(text) {
  // ç§»é™¤æ§åˆ¶å­—ç¬¦
  text = text.replace(/[\u0000-\u001F\u007F]/g, '');

  // æå– ```json``` ä»£ç å—
  const codeBlockMatch = text.match(/```json\s*([\s\S]*?)\s*```/i);

  // æå– {...} JSON å¯¹è±¡
  // ...
}
````

**ä¼˜ç‚¹**: æ‚¨çš„è§£æé€»è¾‘éå¸¸å¥å£®ï¼Œèƒ½å¤„ç†å„ç§ AI è¾“å‡ºæ ¼å¼ã€‚

---

### 3. å¢å¼ºé”™è¯¯å¤„ç†

**ä¿®æ”¹å‰ï¼ˆæ‚¨çš„åŸä»£ç ï¼‰**:

```javascript
if (!cleanedJson) {
  return {
    json: {
      é”™è¯¯: 'æ— æ³•æ‰¾åˆ°æœ‰æ•ˆçš„JSONå†…å®¹',
      åŸå§‹è¾“å‡ºç±»å‹: typeof rawOutput,
      // ...
    },
  };
}
```

**ä¿®æ”¹åï¼ˆå¼‚æ­¥ç‰ˆæœ¬ï¼‰**:

```javascript
if (!cleanedJson) {
  // ä»ç„¶è¿”å›ç»“æœï¼Œä½†æ ‡è®°ä¸º parseError
  const result = {
    parseError: true,
    errorMessage: 'æ— æ³•æ‰¾åˆ°æœ‰æ•ˆçš„JSONå†…å®¹',
    fullReport: String(rawOutput)
  };

  return [{
    json: {
      taskId: taskId,
      status: 'completed',  // â† ä»ç„¶æ˜¯ completedï¼Œä½†æœ‰ parseError
      result: result,
      completedAt: new Date().toISOString(),
      duration: ...
    }
  }];
}
```

**ä½œç”¨**:

- å³ä½¿è§£æå¤±è´¥ï¼Œä»»åŠ¡ä¹Ÿæ ‡è®°ä¸º `completed`
- `result` ä¸­åŒ…å« `parseError: true` æ ‡è®°
- å‰ç«¯å¯ä»¥æ£€æµ‹å¹¶æ˜¾ç¤ºåŸå§‹å†…å®¹

---

### 4. ä¿ç•™å®Œæ•´çš„æ•°æ®ç»“æ„

**ä¿ç•™åŸæœ‰æ•°æ®ç»“æ„**:

```javascript
const result = {
  å‘å¸ƒå†…å®¹: { ... },
  Googleè¡¨æ ¼æ•°æ®: { ... },
  ç»Ÿè®¡æ•°æ®: { ... },
  å®¡æ ¸çŠ¶æ€: { ... },
  å›¾ç‰‡å¡ç‰‡æ–‡æ¡ˆ: imageCards,

  // æ–°å¢ï¼šæ–¹ä¾¿å‰ç«¯è®¿é—®çš„ç®€åŒ–å­—æ®µ
  title: reviewedContent.title || '',
  content: reviewedContent.content || '',
  tags: reviewedContent.tags || [],
  fullReport: rawOutput
};
```

**ä¼˜ç‚¹**:

- ä¿ç•™æ‚¨åŸæœ‰çš„æ‰€æœ‰æ•°æ®ç»“æ„
- æ·»åŠ ç®€åŒ–å­—æ®µæ–¹ä¾¿å‰ç«¯å¿«é€Ÿè®¿é—®
- `fullReport` åŒ…å«å®Œæ•´çš„ AI è¾“å‡º

---

### 5. ä¿®æ”¹è¿”å›æ ¼å¼

**ä¿®æ”¹å‰ï¼ˆæ‚¨çš„åŸä»£ç ï¼‰**:

```javascript
return { json: output };
```

**ä¿®æ”¹åï¼ˆå¼‚æ­¥ç‰ˆæœ¬ï¼‰**:

```javascript
return {
  // â† å•ä¸ªå¯¹è±¡ï¼ˆRun Once for Each Item æ¨¡å¼ï¼‰
  json: {
    taskId: taskId,
    status: 'completed',
    result: result, // â† æ‚¨çš„å®Œæ•´æ•°æ®ç»“æ„
    completedAt: new Date().toISOString(),
    duration: duration,
  },
};
```

**åŸå› **: åœ¨ "Run Once for Each Item" æ¨¡å¼ä¸‹ï¼Œéœ€è¦è¿”å›å•ä¸ªå¯¹è±¡ã€‚

---

## ğŸ“Š æ•°æ®æµå¯¹æ¯”

### ä¿®æ”¹å‰ï¼ˆåŸä»£ç ï¼‰

```
AI Agent è¾“å‡º
   â†“
è§£æ JSON
   â†“
æ„å»º output å¯¹è±¡
   â†“
è¿”å› { json: output }
   â†“
ç›´æ¥ç”¨äºåç»­å¤„ç†
```

### ä¿®æ”¹åï¼ˆå¼‚æ­¥ç‰ˆæœ¬ï¼‰

```
AI Agent è¾“å‡º
   â†“
è·å– taskIdï¼ˆä»å‰é¢èŠ‚ç‚¹ï¼‰
   â†“
è§£æ JSONï¼ˆä½¿ç”¨æ‚¨çš„é€»è¾‘ï¼‰
   â†“
æ„å»º result å¯¹è±¡ï¼ˆä¿ç•™æ‚¨çš„ç»“æ„ï¼‰
   â†“
è¿”å› [{
  json: {
    taskId: taskId,
    status: 'completed',
    result: result,  // â† åŒ…å«æ‚¨çš„å®Œæ•´æ•°æ®
    completedAt: ...,
    duration: ...
  }
}]
   â†“
Update row(s)2 èŠ‚ç‚¹
   â†“
å­˜å‚¨åˆ°æ•°æ®åº“ï¼ˆä½¿ç”¨ JSON.stringifyï¼‰
```

---

## ğŸ¯ å…³é”®ç‰¹æ€§

### 1. ä¿ç•™åŸæœ‰åŠŸèƒ½

âœ… æ™ºèƒ½ JSON æå–ï¼ˆ`json` ä»£ç å—ã€{...} å¯¹è±¡ï¼‰  
âœ… å®Œæ•´çš„æ•°æ®ç»“æ„ï¼ˆå‘å¸ƒå†…å®¹ã€Googleè¡¨æ ¼æ•°æ®ã€ç»Ÿè®¡ã€å®¡æ ¸ï¼‰  
âœ… è®¾è®¡å¸ˆæ ¼å¼ç”Ÿæˆ  
âœ… åˆ†ç±»æå–

### 2. æ–°å¢åŠŸèƒ½

âœ… taskId è‡ªåŠ¨è·å–  
âœ… å¤„ç†æ—¶é•¿è®¡ç®—  
âœ… é”™è¯¯å¤„ç†å¢å¼ºï¼ˆparseError æ ‡è®°ï¼‰  
âœ… ç®€åŒ–å­—æ®µï¼ˆtitleã€contentã€tagsï¼‰  
âœ… æ•°ç»„è¿”å›æ ¼å¼

---

## ğŸ” result å¯¹è±¡ç»“æ„

### æ­£å¸¸æƒ…å†µï¼ˆè§£ææˆåŠŸï¼‰

```javascript
{
  å‘å¸ƒå†…å®¹: {
    æ ‡é¢˜: "...",
    æ­£æ–‡: "...",
    æ ‡ç­¾æ•°ç»„: [...],
    å®Œæ•´å‘å¸ƒæ–‡æœ¬: "..."
  },
  Googleè¡¨æ ¼æ•°æ®: {
    æ ‡é¢˜: "...",
    æ­£æ–‡: "...",
    æ ‡ç­¾: "...",
    å›¾ç‰‡æç¤ºè¯: "...",
    è§†é¢‘æç¤ºè¯: "...",
    å›¾ç‰‡å¡ç‰‡è®¾è®¡: "...",
    å­—æ•°: 1234,
    æ®µè½æ•°: 10,
    å¡ç‰‡æ•°é‡: 7,
    åˆ›å»ºæ—¶é—´: "...",
    å®¡æ ¸çŠ¶æ€: "å·²é€šè¿‡",
    é£é™©ç­‰çº§: "ä½é£é™©",
    çŠ¶æ€: "å¾…å‘å¸ƒ",
    åˆ†ç±»: "å®¶åº­"
  },
  ç»Ÿè®¡æ•°æ®: {
    æ ‡é¢˜å­—æ•°: 20,
    æ­£æ–‡å­—æ•°: 1500,
    å›¾ç‰‡å¡ç‰‡æ•°é‡: 7
  },
  å®¡æ ¸çŠ¶æ€: {
    è¿è§„è¯ä¿®æ”¹è®°å½•: [...],
    é£é™©è¯„ä¼°: "ä½é£é™©",
    æ˜¯å¦é€šè¿‡å®¡æ ¸: true
  },
  å›¾ç‰‡å¡ç‰‡æ–‡æ¡ˆ: [...],
  fullReport: "å®Œæ•´çš„AIè¾“å‡º...",
  title: "...",
  content: "...",
  tags: [...],
  imagePrompt: "...",
  videoPrompt: "..."
}
```

### é”™è¯¯æƒ…å†µï¼ˆè§£æå¤±è´¥ï¼‰

```javascript
{
  parseError: true,
  errorMessage: "JSONè§£æå¤±è´¥: ...",
  rawOutput: "å‰1000å­—ç¬¦...",
  fullReport: "å®Œæ•´çš„AIè¾“å‡º..."
}
```

---

## ğŸ“ åœ¨ n8n ä¸­ä½¿ç”¨

### èŠ‚ç‚¹é…ç½®

**Code èŠ‚ç‚¹è®¾ç½®**:

- Mode: `Run Once for Each Item`
- ç²˜è´´ä¿®æ”¹åçš„ä»£ç 

**å‰ç½®èŠ‚ç‚¹**:

- `Update row(s)1`: å°†çŠ¶æ€æ›´æ–°ä¸º `processing`
- `Get row(s)1`: è·å–ä»»åŠ¡æ•°æ®

**åç½®èŠ‚ç‚¹**:

- `Update row(s)2`: å­˜å‚¨ç»“æœ
  - `result`: `={{ JSON.stringify($json.result) }}`
  - `status`: `completed`
  - `completedAt`: `={{ $json.completedAt }}`
  - `duration`: `={{ $json.duration }}`

---

## ğŸ§ª æµ‹è¯•æ£€æŸ¥

### æ£€æŸ¥æ—¥å¿—è¾“å‡º

**æ­£å¸¸æƒ…å†µ**:

```javascript
âœ… ä» Update row(s)1 è·å–åˆ° taskId: content_task_xxx
Task ID: content_task_xxx
Raw output type: string
Raw output length: 5000
âœ… JSON è§£ææˆåŠŸ
æå–çš„æ ‡é¢˜: çˆ¸å¦ˆçœå°é’±èŠ±å¤§é’±ï¼Ÿ...
å›¾ç‰‡å¡ç‰‡æ•°é‡: 7
å®¡æ ¸çŠ¶æ€: ä½é£é™©
âœ… Processing complete
Duration: 45 seconds
```

**è§£æå¤±è´¥**:

```javascript
âŒ æ— æ³•æ‰¾åˆ°æœ‰æ•ˆçš„JSONå†…å®¹
```

ï¼ˆä½†ä»ä¼šè¿”å› `completed` çŠ¶æ€ï¼Œå¸¦ `parseError: true`ï¼‰

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. èŠ‚ç‚¹å‘½å

ç¡®ä¿å‰é¢çš„èŠ‚ç‚¹å‘½åæ­£ç¡®ï¼š

- `Update row(s)1` - æ›´æ–°çŠ¶æ€ä¸º processing
- `Get row(s)1` - è·å–ä»»åŠ¡æ•°æ®

å¦‚æœèŠ‚ç‚¹åç§°ä¸åŒï¼Œä¿®æ”¹ä»£ç ä¸­çš„èŠ‚ç‚¹å¼•ç”¨ï¼š

```javascript
const updateNode = $('Your_Node_Name').first().json;
```

### 2. AI Agent è¾“å‡ºæ ¼å¼

ç¡®ä¿ AI Agent è¿”å›çš„æ•°æ®åŒ…å«ï¼š

```json
{
  "å®¡æ ¸ä¼˜åŒ–åæ–‡æ¡ˆ": {
    "title": "...",
    "content": "...",
    "tags": [...]
  },
  "å›¾ç‰‡å¡ç‰‡æ–‡æ¡ˆ": [...],
  "å®¡æ ¸æŠ¥å‘Š": {...}
}
```

### 3. æ•°æ®åº“å­˜å‚¨

åœ¨ `Update row(s)2` èŠ‚ç‚¹ä¸­ï¼Œ**å¿…é¡»ä½¿ç”¨ JSON.stringify**ï¼š

```javascript
"result": "={{ JSON.stringify($json.result) }}"
```

---

## âœ… ä¼˜åŠ¿æ€»ç»“

| ç‰¹æ€§           | åŸä»£ç       | ä¿®æ”¹å                |
| -------------- | ----------- | --------------------- |
| **JSON è§£æ**  | âœ… æ™ºèƒ½æå– | âœ… ä¿ç•™åŸé€»è¾‘         |
| **æ•°æ®ç»“æ„**   | âœ… å®Œæ•´     | âœ… å®Œæ•´ä¿ç•™           |
| **å¼‚æ­¥æ”¯æŒ**   | âŒ æ—        | âœ… æ”¯æŒ taskId        |
| **é”™è¯¯å¤„ç†**   | âœ… åŸºç¡€     | âœ… å¢å¼ºï¼ˆparseErrorï¼‰ |
| **å‰ç«¯å…¼å®¹**   | âœ… å¯ç”¨     | âœ… ç®€åŒ–å­—æ®µ           |
| **æ•°æ®åº“å­˜å‚¨** | âŒ ä¸é€‚é…   | âœ… å®Œå…¨é€‚é…           |

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- **å®Œæ•´é…ç½®**: [REDNOTE_CONTENT_ASYNC_SETUP.md](./REDNOTE_CONTENT_ASYNC_SETUP.md)
- **å¿«é€Ÿå¼€å§‹**: [CONTENT_ASYNC_QUICK_START.md](./CONTENT_ASYNC_QUICK_START.md)
- **ä»£ç æ–‡ä»¶**: [workflows/content-workflow2-code-parse-ai-output.js](./workflows/content-workflow2-code-parse-ai-output.js)

---

## ğŸ‰ æ€»ç»“

**æ‚¨çš„è§£æä»£ç éå¸¸ä¼˜ç§€ï¼Œæˆ‘ä»¬åªæ˜¯åšäº†æœ€å°åŒ–çš„è°ƒæ•´ï¼š**

1. âœ… æ·»åŠ  taskId è·å–é€»è¾‘ï¼ˆå¼€å¤´ï¼‰
2. âœ… å¢å¼ºé”™è¯¯å¤„ç†ï¼ˆparseError æ ‡è®°ï¼‰
3. âœ… ä¿®æ”¹è¿”å›æ ¼å¼ï¼ˆæ•°ç»„ï¼‰
4. âœ… æ·»åŠ è®¡ç®—å¤„ç†æ—¶é•¿
5. âœ… ä¿ç•™æ‰€æœ‰åŸæœ‰åŠŸèƒ½å’Œæ•°æ®ç»“æ„

**ç°åœ¨è¿™ä¸ªä»£ç å®Œç¾é€‚é…å¼‚æ­¥å¤„ç†æ¶æ„ï¼ŒåŒæ—¶ä¿ç•™äº†æ‚¨åŸæœ‰çš„æ‰€æœ‰åŠŸèƒ½ï¼** ğŸš€
