# ğŸ” é…ç½®è‡ªæ£€æ¸…å• - é€æ­¥æ’æŸ¥

## ğŸ“‹ Step 1: æ£€æŸ¥å·¥ä½œæµ1ï¼ˆæäº¤ä»»åŠ¡ï¼‰

### 1.1 æ‰¾åˆ°æ­£ç¡®çš„å·¥ä½œæµ

- [ ] åœ¨ n8n ä¸­æ‰¾åˆ°åŒ…å« `rednotesubject` webhook çš„å·¥ä½œæµ
- [ ] å·¥ä½œæµçŠ¶æ€æ˜¾ç¤ºä¸º **"Active"**ï¼ˆç»¿è‰²ï¼‰

---

### 1.2 æ£€æŸ¥ Execute Workflow èŠ‚ç‚¹

æ‰“å¼€ `Execute Workflow` æˆ– `Call 'RedNote Subject - Main workflow'` èŠ‚ç‚¹ï¼š

#### é…ç½®æ£€æŸ¥è¡¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Execute Workflow èŠ‚ç‚¹é…ç½®                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… Workflow: é€‰æ‹©äº†ä¸»å¤„ç†å·¥ä½œæµ            â”‚
â”‚ âœ… Workflow Inputs:                        â”‚
â”‚    - subject: {{ $json.subject }}          â”‚
â”‚    - taskId: {{ $json.taskId }}            â”‚
â”‚                                            â”‚
â”‚ âš ï¸ Options:                                â”‚
â”‚    [ ] Wait For Sub-Workflow Completion    â”‚
â”‚        â†‘                                   â”‚
â”‚        å¿…é¡»å–æ¶ˆå‹¾é€‰ï¼                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### JSON é…ç½®æ£€æŸ¥

å¦‚æœæ‚¨æŸ¥çœ‹ JSON é…ç½®ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```json
{
  "parameters": {
    "workflowId": "...",
    "options": {
      "waitForSubWorkflow": false  â† âš ï¸ å¿…é¡»æ˜¯ falseï¼
    }
  }
}
```

**âŒ é”™è¯¯é…ç½®ç¤ºä¾‹**ï¼š

```json
{
  "parameters": {
    "workflowId": "...",
    "options": {
      "waitForSubWorkflow": true  â† âŒ è¿™ä¼šå¯¼è‡´ 524 é”™è¯¯ï¼
    }
  }
}
```

æˆ–è€…æ²¡æœ‰ `options` éƒ¨åˆ†ï¼ˆé»˜è®¤ä¸º trueï¼‰ï¼š

```json
{
  "parameters": {
    "workflowId": "..."
    // âŒ ç¼ºå°‘ optionsï¼Œé»˜è®¤ç­‰å¾…å­å·¥ä½œæµ
  }
}
```

---

### 1.3 æ£€æŸ¥è¿æ¥é¡ºåº

#### æŸ¥çœ‹æ–¹æ³•

åœ¨ n8n å·¥ä½œæµç”»å¸ƒä¸Šï¼Œæ£€æŸ¥èŠ‚ç‚¹ä¹‹é—´çš„è¿çº¿ï¼š

```
æ­£ç¡®çš„è¿æ¥ï¼ˆæ¨èï¼‰ï¼š
Webhook
    â†“
Generate Task ID
    â†“
Insert row
    â†“
    â”œâ”€ Respond to Webhook (ä¸»è¦è¾“å‡º)
    â””â”€ Execute Workflow (æ¬¡è¦è¾“å‡ºï¼Œä¸ç­‰å¾…)
```

#### æ£€æŸ¥æ¸…å•

- [ ] `Insert row` è¿æ¥åˆ° `Respond to Webhook`
- [ ] `Insert row` ä¹Ÿè¿æ¥åˆ° `Execute Workflow`
- [ ] `Execute Workflow` ä¸åœ¨ `Respond to Webhook` ä¹‹å‰

---

### 1.4 æ£€æŸ¥ Webhook CORS é…ç½®

æ‰“å¼€ `Webhook` èŠ‚ç‚¹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Webhook èŠ‚ç‚¹é…ç½®                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ HTTP Method: POST                          â”‚
â”‚ Path: rednotesubject                       â”‚
â”‚                                            â”‚
â”‚ âš ï¸ Options:                                â”‚
â”‚    Allowed Origins (CORS): *               â”‚
â”‚                            â†‘               â”‚
â”‚                      å¿…é¡»è®¾ç½®ä¸º *           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### JSON é…ç½®æ£€æŸ¥

```json
{
  "parameters": {
    "httpMethod": "POST",
    "path": "rednotesubject",
    "options": {
      "allowedOrigins": "*"  â† âš ï¸ å¿…é¡»é…ç½®
    }
  }
}
```

---

## ğŸ“‹ Step 2: æ£€æŸ¥å·¥ä½œæµ3ï¼ˆæŸ¥è¯¢çŠ¶æ€ï¼‰

### 2.1 æ‰¾åˆ°æŸ¥è¯¢å·¥ä½œæµ

- [ ] æ‰¾åˆ°åŒ…å« `task-status` çš„å·¥ä½œæµ
- [ ] å·¥ä½œæµçŠ¶æ€æ˜¾ç¤ºä¸º **"Active"**

---

### 2.2 æ£€æŸ¥ Webhook é…ç½®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Webhook èŠ‚ç‚¹é…ç½®                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ HTTP Method: GET                           â”‚
â”‚ Path: task-status/:taskId                  â”‚
â”‚       â†‘                                    â”‚
â”‚       æ³¨æ„å†’å·ï¼Œè¿™æ˜¯è·¯å¾„å‚æ•°                â”‚
â”‚                                            â”‚
â”‚ âš ï¸ Options:                                â”‚
â”‚    Allowed Origins (CORS): *               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ£€æŸ¥æ¸…å•

- [ ] HTTP Method æ˜¯ `GET`ï¼ˆæˆ–ç•™ç©ºé»˜è®¤ï¼‰
- [ ] Path æ˜¯ `task-status/:taskId`ï¼ˆæ³¨æ„å†’å·ï¼‰
- [ ] CORS é…ç½®ä¸º `*`

---

## ğŸ“‹ Step 3: æ£€æŸ¥å‰ç«¯ä»£ç 

### 3.1 æ£€æŸ¥æŒ‰é’®ç»‘å®š

æ‰“å¼€ `src/pages/SocialMedia/components/RedNoteContentGenerator.tsx`

æ‰¾åˆ°è¿™ä¸€è¡Œï¼š

```typescript
onClick={handleGenerateSubjectAsync}  â† âš ï¸ å¿…é¡»æ˜¯ Async ç‰ˆæœ¬ï¼
```

**âŒ é”™è¯¯ç¤ºä¾‹**ï¼š

```typescript
onClick={handleGenerateSubject}  â† âŒ è¿™æ˜¯åŒæ­¥ç‰ˆæœ¬ï¼Œä¼šè¶…æ—¶ï¼
```

---

### 3.2 æ£€æŸ¥æŸ¥è¯¢ URL

åœ¨ `handleGenerateSubjectAsync` å‡½æ•°ä¸­ï¼Œæ‰¾åˆ°ï¼š

```typescript
const statusUrl = `https://n8n.wendealai.com/webhook/task-status/${taskId}`;
```

**æ£€æŸ¥æ¸…å•**ï¼š

- [ ] URL æ ¼å¼æ­£ç¡®ï¼š`/webhook/task-status/${taskId}`
- [ ] ä½¿ç”¨æ¨¡æ¿å­—ç¬¦ä¸²ï¼ˆåå¼•å·ï¼‰
- [ ] `${taskId}` æ˜¯åŠ¨æ€æ›¿æ¢çš„

---

## ğŸ“‹ Step 4: æµ‹è¯•éªŒè¯

### 4.1 å‘½ä»¤è¡Œæµ‹è¯•ï¼ˆæ¨èï¼‰

#### æµ‹è¯• 1ï¼šæäº¤ä»»åŠ¡

```bash
time curl -X POST https://n8n.wendealai.com/webhook/rednotesubject \
  -H "Content-Type: application/json" \
  -d '{"subject":"æµ‹è¯•ä¸»é¢˜","timestamp":"2025-10-30T10:00:00Z"}' \
  -w "\nResponse Time: %{time_total}s\n"
```

**é¢„æœŸè¾“å‡º**ï¼š

```json
{
  "taskId": "task_1730275200000_abc123",
  "status": "pending",
  "subject": "æµ‹è¯•ä¸»é¢˜",
  "createdAt": "2025-10-30T10:00:00.000Z"
}

Response Time: 0.5s
```

**âœ… æˆåŠŸæ ‡å¿—**ï¼š

- å“åº”æ—¶é—´ < 1ç§’
- è¿”å›äº† `taskId`
- æ—  524 é”™è¯¯
- æ—  CORS é”™è¯¯

**âŒ å¤±è´¥æ ‡å¿—**ï¼š

- å“åº”æ—¶é—´ > 10ç§’
- è¿”å› 524 é”™è¯¯
- æ— å“åº”

---

#### æµ‹è¯• 2ï¼šæŸ¥è¯¢çŠ¶æ€

```bash
# å°† {taskId} æ›¿æ¢ä¸ºä¸Šä¸€æ­¥è¿”å›çš„ taskId
curl -X GET "https://n8n.wendealai.com/webhook/task-status/{taskId}"
```

**é¢„æœŸè¾“å‡º**ï¼š

```json
{
  "taskId": "task_1730275200000_abc123",
  "status": "pending" æˆ– "processing" æˆ– "completed",
  "message": "...",
  ...
}
```

**âœ… æˆåŠŸæ ‡å¿—**ï¼š

- è¿”å›äº† JSON æ•°æ®
- åŒ…å« `taskId` å’Œ `status`
- æ—  404 é”™è¯¯

---

### 4.2 å‰ç«¯æµ‹è¯•

1. **åˆ·æ–°æµè§ˆå™¨**ï¼ˆCtrl + Shift + Rï¼‰
2. **æ‰“å¼€å¼€å‘è€…å·¥å…·**ï¼ˆF12ï¼‰â†’ Console æ ‡ç­¾
3. **è®¿é—®**ï¼š`http://localhost:5174`
4. **è¿›å…¥**ï¼šSocial Media â†’ Rednote Content Generator
5. **è¾“å…¥ä¸»é¢˜**ï¼š`æµ‹è¯•ä¸»é¢˜`
6. **ç‚¹å‡»**ï¼šGenerate Subject

#### è§‚å¯Ÿ Console æ—¥å¿—

**âœ… æˆåŠŸæ—¥å¿—ç¤ºä¾‹**ï¼š

```
ğŸ“¤ Submitting async task...
âœ… Task created: task_1730275200000_abc123
ğŸ“ Status URL: https://n8n.wendealai.com/webhook/task-status/task_1730275200000_abc123
ğŸ”„ Polling attempt 1/240...
ğŸ“Š Task status: {status: "pending", ...}
Processing... (5s elapsed)
ğŸ”„ Polling attempt 2/240...
ğŸ“Š Task status: {status: "processing", ...}
Processing... (10s elapsed)
...
ğŸ‰ Task completed!
ğŸ“„ Result: {...}
```

**âŒ å¤±è´¥æ—¥å¿—ç¤ºä¾‹**ï¼š

```
Subject fetch error: TypeError: NetworkError when attempting to fetch resource
Subject generation failed: Error: CORS error...
```

æˆ–è€…ï¼š

```
Subject fetch error: Status code: 524
```

---

## ğŸ“Š é—®é¢˜è¯Šæ–­è¡¨

### ç—‡çŠ¶ 1ï¼š524 è¶…æ—¶é”™è¯¯

| å¯èƒ½åŸå›                       | æ£€æŸ¥é¡¹   | è§£å†³æ–¹æ³•                                 |
| ----------------------------- | -------- | ---------------------------------------- |
| Execute Workflow ç­‰å¾…å­å·¥ä½œæµ | Step 1.2 | å–æ¶ˆå‹¾é€‰ "Wait For Sub-Workflow"         |
| è¿æ¥é¡ºåºé”™è¯¯                  | Step 1.3 | è°ƒæ•´è¿æ¥ï¼šInsert row â†’ Respond â†’ Execute |
| å·¥ä½œæµæœªä¿å­˜                  | -        | é‡æ–°ä¿å­˜å·¥ä½œæµ                           |

---

### ç—‡çŠ¶ 2ï¼šCORS é”™è¯¯

| å¯èƒ½åŸå›             | æ£€æŸ¥é¡¹        | è§£å†³æ–¹æ³•                    |
| ------------------- | ------------- | --------------------------- |
| Webhook æœªé…ç½® CORS | Step 1.4, 2.2 | è®¾ç½® Allowed Origins ä¸º `*` |
| 524 è¶…æ—¶å¯¼è‡´        | Step 1.2      | å…ˆä¿®å¤ 524 é—®é¢˜             |
| æµè§ˆå™¨ç¼“å­˜          | -             | æ¸…é™¤ç¼“å­˜æˆ–ä½¿ç”¨æ— ç—•æ¨¡å¼      |

---

### ç—‡çŠ¶ 3ï¼šå‰ç«¯ä»è¶…æ—¶

| å¯èƒ½åŸå›        | æ£€æŸ¥é¡¹   | è§£å†³æ–¹æ³•                          |
| -------------- | -------- | --------------------------------- |
| ä½¿ç”¨äº†åŒæ­¥å‡½æ•° | Step 3.1 | æ”¹ä¸º `handleGenerateSubjectAsync` |
| ä»£ç æœªæ›´æ–°     | -        | ç¡¬åˆ·æ–°æµè§ˆå™¨ï¼ˆCtrl+Shift+Rï¼‰      |
| URL æ ¼å¼é”™è¯¯   | Step 3.2 | æ£€æŸ¥ statusUrl æ ¼å¼               |

---

### ç—‡çŠ¶ 4ï¼šæŸ¥è¯¢è¿”å› 404

| å¯èƒ½åŸå›           | æ£€æŸ¥é¡¹   | è§£å†³æ–¹æ³•                   |
| ----------------- | -------- | -------------------------- |
| å·¥ä½œæµ3æœªæ¿€æ´»     | Step 2.1 | æ¿€æ´»å·¥ä½œæµ3                |
| Webhook path é”™è¯¯ | Step 2.2 | æ”¹ä¸º `task-status/:taskId` |
| URL æ ¼å¼é”™è¯¯      | Step 3.2 | æ£€æŸ¥å‰ç«¯ URL æ ¼å¼          |

---

## ğŸ¯ å¿«é€Ÿè‡ªæ£€æµç¨‹

### â° 1åˆ†é’Ÿå¿«é€Ÿæ£€æŸ¥

1. âœ… å·¥ä½œæµ1çš„ Execute Workflow â†’ Options â†’ "Wait For Sub-Workflow" **å–æ¶ˆå‹¾é€‰**
2. âœ… å·¥ä½œæµ1çš„ Webhook â†’ Options â†’ "Allowed Origins" è®¾ç½®ä¸º `*`
3. âœ… å·¥ä½œæµ3çš„ Webhook â†’ Path è®¾ç½®ä¸º `task-status/:taskId`
4. âœ… å‰ç«¯æŒ‰é’®ç»‘å®š `handleGenerateSubjectAsync`
5. âœ… æ‰€æœ‰å·¥ä½œæµçŠ¶æ€ä¸º **"Active"**

### â° 2åˆ†é’Ÿæµ‹è¯•éªŒè¯

```bash
# 1. æµ‹è¯•æäº¤ï¼ˆåº”è¯¥ < 1ç§’è¿”å›ï¼‰
time curl -X POST https://n8n.wendealai.com/webhook/rednotesubject \
  -H "Content-Type: application/json" \
  -d '{"subject":"æµ‹è¯•","timestamp":"2025-10-30T10:00:00Z"}'

# 2. è®°å½• taskId

# 3. æµ‹è¯•æŸ¥è¯¢ï¼ˆåº”è¯¥è¿”å› pending æˆ– processingï¼‰
curl -X GET "https://n8n.wendealai.com/webhook/task-status/{taskId}"
```

---

## âœ… å…¨éƒ¨æ­£å¸¸çš„æ ‡å¿—

å½“æ‰€æœ‰é…ç½®æ­£ç¡®æ—¶ï¼Œæ‚¨ä¼šçœ‹åˆ°ï¼š

1. âœ… æäº¤ä»»åŠ¡å“åº” < 1ç§’
2. âœ… è¿”å› taskId
3. âœ… æŸ¥è¯¢ä»»åŠ¡è¿”å› JSON æ•°æ®
4. âœ… å‰ç«¯è¿›åº¦æ¡ç§»åŠ¨
5. âœ… çŠ¶æ€æ–‡æœ¬å®æ—¶æ›´æ–°
6. âœ… æ—  524 é”™è¯¯
7. âœ… æ—  CORS é”™è¯¯
8. âœ… æœ€ç»ˆè·å–å®Œæ•´ç»“æœ

---

## ğŸ†˜ ä»ç„¶å¤±è´¥ï¼Ÿ

å¦‚æœæ£€æŸ¥äº†æ‰€æœ‰é…ç½®ä»ç„¶å¤±è´¥ï¼Œè¯·ï¼š

1. å¯¼å‡ºå·¥ä½œæµ1çš„ JSON é…ç½®
2. æŸ¥æ‰¾ `Execute Workflow` èŠ‚ç‚¹çš„é…ç½®
3. æ£€æŸ¥æ˜¯å¦æœ‰ `"waitForSubWorkflow": false`
4. æŸ¥çœ‹ n8n æ‰§è¡Œæ—¥å¿—çš„è¯¦ç»†é”™è¯¯
5. æä¾›å®Œæ•´çš„é”™è¯¯ä¿¡æ¯

---

**è®°ä½**ï¼šæœ€å…³é”®çš„é…ç½®æ˜¯ **Execute Workflow èŠ‚ç‚¹çš„ "Wait For Sub-Workflow Completion" å¿…é¡»å–æ¶ˆå‹¾é€‰ï¼** âš ï¸
