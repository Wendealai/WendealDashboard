{
  "id": "snapshot_1760150372363_y8905erev",
  "approvalId": "approval_1760150372334_3ztvi4syn",
  "approvalTitle": "CRM Module Design - Iframe Integration Architecture",
  "version": 1,
  "timestamp": "2025-10-11T02:39:32.363Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# CRM Module Design\r\n\r\n## Overview\r\nDesign a CRM module that integrates Twenty CRM platform via iframe embedding into the WendealDashboard. The design follows existing architectural patterns while ensuring security, performance, and seamless user experience.\r\n\r\n## System Architecture\r\n\r\n### High-Level Architecture\r\n```\r\n┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐\r\n│   Wendeal       │    │   CRM Module    │    │   Twenty CRM    │\r\n│   Dashboard     │◄──►│   (Iframe)      │◄──►│   Instance      │\r\n│                 │    │                 │    │ crm.wendealai.com│\r\n└─────────────────┘    └─────────────────┘    └─────────────────┘\r\n         │                       │                       │\r\n         └───────────────────────┼───────────────────────┘\r\n                                 │\r\n                    ┌────────────────────┐\r\n                    │   Security Layer   │\r\n                    │   - CORS Policy    │\r\n                    │   - CSP Headers    │\r\n                    │   - Auth Isolation │\r\n                    └────────────────────┘\r\n```\r\n\r\n### Component Architecture\r\n\r\n#### CRM Module Structure\r\n```\r\nsrc/pages/CRM/\r\n├── index.tsx                 # Main CRM page component\r\n├── index.ts                  # Export file\r\n├── styles.css               # CRM-specific styles\r\n└── components/\r\n    ├── CRMContainer.tsx     # Iframe wrapper component\r\n    ├── LoadingState.tsx     # Loading indicator\r\n    ├── ErrorBoundary.tsx    # Error handling\r\n    └── SecurityHeaders.tsx  # Security configuration\r\n```\r\n\r\n## Technical Design\r\n\r\n### Frontend Integration\r\n\r\n#### Route Configuration\r\n- **Path**: `/crm`\r\n- **Component**: Lazy-loaded CRM page\r\n- **Meta Configuration**:\r\n  ```typescript\r\n  {\r\n    title: 'navigation.crm',\r\n    requiresAuth: true,\r\n    roles: ['admin', 'user'],\r\n    icon: 'UserOutlined', // CRM-related icon\r\n  }\r\n  ```\r\n\r\n#### Navigation Integration\r\n- Add CRM item to `navigationItems` in `routes.ts`\r\n- Position: After Tools, before Profile\r\n- Icon: `UserOutlined` (contacts/users icon)\r\n- Label: Internationalized 'CRM' text\r\n\r\n#### Page Component Design\r\n```typescript\r\nconst CRMPage: React.FC = () => {\r\n  const { t } = useTranslation();\r\n\r\n  return (\r\n    <div className='crm-page'>\r\n      <div className='page-header'>\r\n        <Title level={2} style={{ fontSize: '22px' }}>\r\n          {t('crm.title')}\r\n        </Title>\r\n      </div>\r\n\r\n      <CRMContainer\r\n        src=\"https://crm.wendealai.com\"\r\n        title={t('crm.iframeTitle')}\r\n      />\r\n    </div>\r\n  );\r\n};\r\n```\r\n\r\n### Iframe Integration Design\r\n\r\n#### CRMContainer Component\r\n```typescript\r\ninterface CRMContainerProps {\r\n  src: string;\r\n  title: string;\r\n  className?: string;\r\n}\r\n\r\nconst CRMContainer: React.FC<CRMContainerProps> = ({\r\n  src,\r\n  title,\r\n  className\r\n}) => {\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  return (\r\n    <div className={`crm-container ${className}`}>\r\n      {loading && <LoadingState />}\r\n      {error && <ErrorDisplay error={error} />}\r\n\r\n      <iframe\r\n        src={src}\r\n        title={title}\r\n        className=\"crm-iframe\"\r\n        onLoad={() => setLoading(false)}\r\n        onError={() => setError('Failed to load CRM')}\r\n        sandbox=\"allow-same-origin allow-scripts allow-forms allow-popups\"\r\n        referrerPolicy=\"strict-origin-when-cross-origin\"\r\n      />\r\n    </div>\r\n  );\r\n};\r\n```\r\n\r\n#### Security Configuration\r\n```typescript\r\n// Security headers configuration\r\nconst SECURITY_HEADERS = {\r\n  'Content-Security-Policy': `\r\n    frame-src https://crm.wendealai.com;\r\n    frame-ancestors 'self';\r\n  `,\r\n  'X-Frame-Options': 'SAMEORIGIN',\r\n  'Referrer-Policy': 'strict-origin-when-cross-origin',\r\n};\r\n```\r\n\r\n### Styling Design\r\n\r\n#### CSS Architecture\r\n```css\r\n/* CRM Page Styles */\r\n.crm-page {\r\n  height: 100%;\r\n  display: flex;\r\n  flex-direction: column;\r\n}\r\n\r\n.crm-container {\r\n  flex: 1;\r\n  position: relative;\r\n  border-radius: 8px;\r\n  overflow: hidden;\r\n  border: 1px solid var(--border-color);\r\n}\r\n\r\n.crm-iframe {\r\n  width: 100%;\r\n  height: 100%;\r\n  border: none;\r\n  background: var(--card-color);\r\n}\r\n\r\n/* Responsive Design */\r\n@media (max-width: 768px) {\r\n  .crm-iframe {\r\n    height: calc(100vh - 200px);\r\n  }\r\n}\r\n```\r\n\r\n#### Font Hierarchy (Following Recent Updates)\r\n- **Page Title**: 22px (H1 level)\r\n- **Section Headers**: 18px (H2 level)\r\n- **Component Titles**: 16px (H3 level)\r\n- **Body Text**: 14px\r\n- **Auxiliary Text**: 12px\r\n\r\n### Error Handling & Resilience\r\n\r\n#### Error Boundary Component\r\n```typescript\r\nclass CRMErrorBoundary extends React.Component {\r\n  state = { hasError: false, error: null };\r\n\r\n  static getDerivedStateFromError(error: Error) {\r\n    return { hasError: true, error };\r\n  }\r\n\r\n  render() {\r\n    if (this.state.hasError) {\r\n      return <CRMErrorFallback error={this.state.error} />;\r\n    }\r\n\r\n    return this.props.children;\r\n  }\r\n}\r\n```\r\n\r\n#### Fallback UI Design\r\n```typescript\r\nconst CRMErrorFallback: React.FC<{ error: Error | null }> = ({ error }) => (\r\n  <div className=\"crm-error-fallback\">\r\n    <Result\r\n      status=\"error\"\r\n      title=\"CRM Unavailable\"\r\n      subTitle={error?.message || \"Unable to load CRM system\"}\r\n      extra={\r\n        <Button onClick={() => window.location.reload()}>\r\n          Retry\r\n        </Button>\r\n      }\r\n    />\r\n  </div>\r\n);\r\n```\r\n\r\n### Performance Optimization\r\n\r\n#### Loading Strategy\r\n- **Lazy Loading**: CRM page is lazy-loaded\r\n- **Iframe Preloading**: Optional preloading for faster access\r\n- **Resource Hints**: DNS prefetch for crm.wendealai.com\r\n\r\n#### Caching Strategy\r\n```typescript\r\n// Service worker caching for CRM assets\r\nconst CRM_CACHE_NAME = 'crm-cache-v1';\r\nconst CRM_URLS = [\r\n  'https://crm.wendealai.com/static/*',\r\n  'https://crm.wendealai.com/assets/*',\r\n];\r\n```\r\n\r\n### Cross-Origin Communication\r\n\r\n#### PostMessage Integration\r\n```typescript\r\n// Optional: If CRM needs to communicate with dashboard\r\nuseEffect(() => {\r\n  const handleMessage = (event: MessageEvent) => {\r\n    // Validate origin\r\n    if (event.origin !== 'https://crm.wendealai.com') return;\r\n\r\n    // Handle messages from CRM\r\n    switch (event.data.type) {\r\n      case 'CRM_READY':\r\n        // CRM loaded successfully\r\n        break;\r\n      case 'CRM_ERROR':\r\n        // Handle CRM errors\r\n        break;\r\n    }\r\n  };\r\n\r\n  window.addEventListener('message', handleMessage);\r\n  return () => window.removeEventListener('message', handleMessage);\r\n}, []);\r\n```\r\n\r\n### Testing Strategy\r\n\r\n#### Unit Tests\r\n- Component rendering tests\r\n- Error boundary tests\r\n- Loading state tests\r\n\r\n#### Integration Tests\r\n- Iframe loading verification\r\n- Cross-origin communication tests\r\n- Security policy validation\r\n\r\n#### E2E Tests\r\n- Full CRM loading workflow\r\n- Error handling scenarios\r\n- Responsive behavior validation\r\n\r\n### Deployment & Configuration\r\n\r\n#### Environment Variables\r\n```env\r\n# CRM Configuration\r\nCRM_URL=https://crm.wendealai.com\r\nCRM_IFRAME_SANDBOX=allow-same-origin allow-scripts allow-forms allow-popups\r\nCRM_IFRAME_REFERRER_POLICY=strict-origin-when-cross-origin\r\n```\r\n\r\n#### Build Configuration\r\n- Ensure iframe domain is whitelisted in CSP\r\n- Add CRM domain to CORS allowed origins\r\n- Configure proper security headers\r\n\r\n### Monitoring & Analytics\r\n\r\n#### Performance Monitoring\r\n- Iframe load time tracking\r\n- Error rate monitoring\r\n- User interaction analytics\r\n\r\n#### Security Monitoring\r\n- CSP violation reporting\r\n- Failed iframe load alerts\r\n- Cross-origin communication logs\r\n\r\n## Implementation Plan\r\n\r\n### Phase 1: Core Implementation\r\n1. Create CRM page component structure\r\n2. Implement basic iframe integration\r\n3. Add route configuration\r\n4. Update navigation menu\r\n\r\n### Phase 2: Security & Error Handling\r\n1. Implement security headers\r\n2. Add error boundaries\r\n3. Create loading states\r\n4. Add fallback UI\r\n\r\n### Phase 3: Performance & Polish\r\n1. Optimize loading performance\r\n2. Add responsive design\r\n3. Implement caching strategy\r\n4. Add monitoring\r\n\r\n### Phase 4: Testing & Deployment\r\n1. Comprehensive testing\r\n2. Performance validation\r\n3. Security audit\r\n4. Production deployment\r\n\r\n## Risk Mitigation\r\n\r\n### Technical Risks\r\n- **CORS Issues**: Implement proper fallback and error handling\r\n- **Security Vulnerabilities**: Regular security audits and CSP validation\r\n- **Performance Impact**: Monitor and optimize iframe loading\r\n\r\n### Business Risks\r\n- **CRM Unavailability**: Implement offline mode and error messaging\r\n- **Integration Complexity**: Start with minimal viable integration\r\n- **User Adoption**: Ensure seamless experience with existing workflow\r\n\r\n## Success Metrics\r\n\r\n### Technical Metrics\r\n- Iframe load time < 3 seconds\r\n- Error rate < 1%\r\n- Security violations = 0\r\n\r\n### User Experience Metrics\r\n- Navigation time < 1 second\r\n- Successful CRM access rate > 99%\r\n- User satisfaction score > 4.5/5\r\n\r\n### Business Metrics\r\n- CRM feature adoption rate\r\n- Time saved vs external access\r\n- Integration cost efficiency",
  "fileStats": {
    "size": 9537,
    "lines": 356,
    "lastModified": "2025-10-11T02:39:19.745Z"
  },
  "comments": []
}