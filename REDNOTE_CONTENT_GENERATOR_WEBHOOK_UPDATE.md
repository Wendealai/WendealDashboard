# Rednote Content Generator Webhook 数据格式更新

## 更新日期

2025-01-29

## 更新概述

根据新的webhook返回格式，更新了数据解析和显示逻辑，确保所有字段都能正确显示。

## Webhook 返回数据格式

### 新的数据结构

```json
[
  {
    "发布内容": {
      "标题": "...",
      "正文": "...",
      "标签数组": ["#tag1", "#tag2"],
      "完整发布文本": "..."
    },
    "Google表格数据": {
      "标题": "...",
      "正文": "...",
      "标签": "#tag1, #tag2",
      "图片提示词": "...",
      "视频提示词": "...",
      "图片卡片设计": "...",
      "字数": 853,
      "段落数": 14,
      "卡片数量": 7,
      "创建时间": "2025/10/29 16:25:57",
      "审核状态": "已通过",
      "风险等级": "低风险",
      "状态": "待发布",
      "分类": "家庭"
    },
    "统计数据": {
      "标题字数": 26,
      "正文字数": 853,
      "图片卡片数量": 7
    },
    "审核状态": {
      "违规词修改记录": ["最关键→关键", "最好→建议"],
      "风险评估": "低风险",
      "是否通过审核": true
    }
  }
]
```

## 修改内容

### 1. Google Sheet 链接更新

- **新链接**: https://docs.google.com/spreadsheets/d/1Lg9OnVttA6wDUjiCjkenwSVyIIKQkzZuYsitqlypQ2o/edit?usp=sharing
- 更新位置：
  - 响应数据创建时（`apiResponse.googleSheetUrl`）
  - View Google Sheet按钮链接

### 2. 数据解析逻辑更新

#### 数据提取路径

```typescript
// 标题
parsedWebhookResponse?.发布内容?.标题;
parsedWebhookResponse?.Google表格数据?.标题;

// 内容
parsedWebhookResponse?.发布内容?.完整发布文本;
parsedWebhookResponse?.发布内容?.正文;

// 标签
parsedWebhookResponse?.发布内容?.标签数组;
parsedWebhookResponse?.Google表格数据?.标签.split(', ');
```

### 3. UI 显示结构更新

#### 📊 统计数据卡片

显示三个关键指标：

- 标题字数（`统计数据.标题字数`）
- 正文字数（`统计数据.正文字数`）
- 图片卡片数（`统计数据.图片卡片数量`）
- 创建时间（`Google表格数据.创建时间`）

#### 📱 发布内容卡片

显示小红书发布专用格式：

1. **标题** - 可复制
   - 来源：`发布内容.标题`
   - 样式：加粗，字号16px
2. **完整发布文本（推荐复制）** - 可复制
   - 来源：`发布内容.完整发布文本`
   - 样式：保留换行，字号14px
3. **标签**
   - 来源：`发布内容.标签数组`
   - 显示：橙色Tag组件

#### ✅ 审核状态卡片

显示内容审核信息：

1. **风险等级**
   - 来源：`审核状态.风险评估`
   - 颜色：
     - 低风险 → 绿色
     - 中风险 → 橙色
     - 高风险 → 红色
2. **审核状态**
   - 来源：`审核状态.是否通过审核`
   - 显示：已通过/未通过
3. **违规词修改记录**
   - 来源：`审核状态.违规词修改记录`
   - 显示：每条记录一行，带⚠️图标

#### 📋 Google表格数据卡片

显示更多详细信息：

1. **状态信息（3列）**
   - 审核状态：`Google表格数据.审核状态`
   - 状态：`Google表格数据.状态`
   - 分类：`Google表格数据.分类`
2. **图片提示词** - 可复制
   - 来源：`Google表格数据.图片提示词`
   - 用途：AI图片生成
3. **视频提示词** - 可复制
   - 来源：`Google表格数据.视频提示词`
   - 用途：AI视频生成
4. **图片卡片设计** - 可复制
   - 来源：`Google表格数据.图片卡片设计`
   - 显示：保留换行格式

### 4. 删除的旧功能

- ❌ 移除了旧的 `xiaohongshu` 数据结构支持
- ❌ 移除了 `management` 管理数据结构
- ❌ 移除了 `analytics` 分析数据结构

### 5. 兼容性处理

- 如果新字段不存在，使用默认值
- 保持了 `generatedResponse` 对象结构不变
- 向后兼容旧的显示逻辑

## 文件修改列表

### 主要修改

1. `src/pages/SocialMedia/components/RedNoteContentGenerator.tsx`
   - 更新数据解析逻辑（第134-166行）
   - 更新Google Sheet URL
   - 重构4个数据显示卡片：
     - 统计数据卡片（335-363行）
     - 发布内容卡片（365-436行）
     - 审核状态卡片（438-483行）
     - Google表格数据卡片（485-555行）

### 保持不变

- 输入区域布局
- 错误处理逻辑
- 加载状态显示
- 按钮功能

## 数据流程

```
用户输入 → 发送到webhook → 接收响应（数组格式）
                                ↓
                          提取第一个元素
                                ↓
                          解析4个数据部分
                                ↓
        ┌──────────────┬──────────────┬──────────────┬──────────────┐
        ↓              ↓              ↓              ↓              ↓
    发布内容      Google表格数据    统计数据      审核状态      创建响应对象
        ↓              ↓              ↓              ↓              ↓
    显示在UI      显示在UI         显示在UI      显示在UI      存储状态
```

## 测试建议

### 必测场景

1. ✅ 正常返回完整数据
2. ✅ 审核通过的内容
3. ✅ 审核未通过的内容
4. ✅ 包含违规词修改的内容
5. ✅ 不同风险等级的内容（低/中/高）
6. ✅ 所有复制功能

### 边界测试

1. 缺少某些字段的响应
2. 空数组响应
3. 非数组格式响应
4. 字段值为null的情况

### UI测试

1. 所有卡片正确展开
2. 所有文本正确换行
3. 所有复制按钮正常工作
4. Tag颜色正确显示
5. Google Sheet链接可点击

## 注意事项

### 数据字段

- 所有使用中文字段名的地方都使用了可选链操作符（`?.`）
- 提供了默认值以防字段缺失
- 数组字段使用了 `.length > 0` 检查

### 样式

- 使用了不同背景色区分不同卡片
- 风险等级使用颜色编码
- 重要内容加粗显示
- 所有长文本都可复制

### 性能

- 使用了React的条件渲染
- 避免了不必要的重渲染
- console.log用于调试（生产环境可移除）

## 请求超时设置

- **超时时间**: 150秒
- 如果请求超过150秒未响应，将自动中止并提示用户
- 适用于长文本内容生成场景

## 后续优化建议

1. **类型定义**
   - 为新的数据结构创建TypeScript接口
   - 更新 `RedNoteWebhookResponse` 类型

2. **错误处理** ✅ 已完成
   - 添加详细的CORS错误提示
   - 区分网络错误、超时错误、HTTP错误
   - 提供具体的修复建议

3. **数据验证**
   - 添加响应数据结构验证
   - 验证必填字段是否存在

4. **UI优化**
   - 添加骨架屏加载效果
   - 添加数据刷新功能
   - 支持编辑和重新生成

## 版本信息

- 修改版本：v2.0
- 修改日期：2025-01-29
- 修改人：AI Assistant
- 兼容性：向后兼容v1.0
