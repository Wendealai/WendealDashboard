<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reddit Webhook 测试</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #f6ffed; border-color: #b7eb8f; }
        .error { background-color: #fff2f0; border-color: #ffb3b3; }
        .info { background-color: #f0f9ff; border-color: #87ceeb; }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #40a9ff; }
        pre {
            background: #f8f8f8;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Reddit Webhook 修复测试</h1>
        
        <div class="test-section info">
            <h3>📋 测试概述</h3>
            <p>这个页面用于测试Reddit工作流webhook返回结果的显示问题修复。</p>
            <p><strong>问题描述：</strong> Reddit hot posts工作流无法正常显示webhook返回结果</p>
            <p><strong>修复内容：</strong></p>
            <ul>
                <li>✅ 确认webhook端点正常工作</li>
                <li>✅ 修复数据格式解析问题</li>
                <li>✅ 添加新的RedditWorkflowResponse数据格式支持</li>
                <li>✅ 修复字段映射错误（upvotes/score）</li>
                <li>✅ 完善数据传递链路</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>🌐 网络连接测试</h3>
            <button onclick="testWebhookConnection()">测试Webhook连接</button>
            <div id="connectionResult"></div>
        </div>

        <div class="test-section">
            <h3>📡 数据获取测试</h3>
            <button onclick="fetchRedditData()">获取Reddit数据</button>
            <div id="dataResult"></div>
        </div>

        <div class="test-section">
            <h3>🔍 数据格式验证</h3>
            <button onclick="validateDataFormat()">验证数据格式</button>
            <div id="formatResult"></div>
        </div>
    </div>

    <script>
        async function testWebhookConnection() {
            const resultDiv = document.getElementById('connectionResult');
            resultDiv.innerHTML = '<div class="status info">🔄 正在测试连接...</div>';
            
            try {
                const response = await fetch('https://n8n.wendealai.com/webhook/reddithot', {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="status success">
                            ✅ 连接成功！<br>
                            状态码: ${response.status}<br>
                            内容类型: ${response.headers.get('content-type')}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="status error">
                            ❌ 连接失败<br>
                            状态码: ${response.status}<br>
                            错误: ${response.statusText}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status error">
                        ❌ 网络错误: ${error.message}
                    </div>
                `;
            }
        }

        async function fetchRedditData() {
            const resultDiv = document.getElementById('dataResult');
            resultDiv.innerHTML = '<div class="status info">🔄 正在获取Reddit数据...</div>';
            
            try {
                const response = await fetch('https://n8n.wendealai.com/webhook/reddithot', {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('获取到的数据:', data);
                    
                    resultDiv.innerHTML = `
                        <div class="status success">
                            ✅ 数据获取成功！<br>
                            数据大小: ${JSON.stringify(data).length} 字符<br>
                            <details>
                                <summary>查看原始数据</summary>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="status error">
                            ❌ 数据获取失败<br>
                            状态码: ${response.status}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status error">
                        ❌ 获取错误: ${error.message}
                    </div>
                `;
            }
        }

        async function validateDataFormat() {
            const resultDiv = document.getElementById('formatResult');
            resultDiv.innerHTML = '<div class="status info">🔄 正在验证数据格式...</div>';
            
            try {
                const response = await fetch('https://n8n.wendealai.com/webhook/reddithot', {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // 验证新的Reddit工作流数据格式
                    const actualData = data.json || data;
                    const validations = [];
                    
                    // 检查必需字段
                    if (actualData.success !== undefined) {
                        validations.push('✅ success 字段存在');
                    } else {
                        validations.push('❌ success 字段缺失');
                    }
                    
                    if (actualData.headerInfo) {
                        validations.push('✅ headerInfo 字段存在');
                    } else {
                        validations.push('❌ headerInfo 字段缺失');
                    }
                    
                    if (actualData.summary) {
                        validations.push('✅ summary 字段存在');
                    } else {
                        validations.push('❌ summary 字段缺失');
                    }
                    
                    if (actualData.subreddits && Array.isArray(actualData.subreddits)) {
                        validations.push(`✅ subreddits 数组存在 (${actualData.subreddits.length} 个)`);
                        
                        // 验证第一个subreddit的结构
                        if (actualData.subreddits.length > 0) {
                            const firstSub = actualData.subreddits[0];
                            if (firstSub.name && firstSub.posts && Array.isArray(firstSub.posts)) {
                                validations.push(`✅ 子版块结构正确 (${firstSub.posts.length} 个帖子)`);
                                
                                // 验证第一个帖子的结构
                                if (firstSub.posts.length > 0) {
                                    const firstPost = firstSub.posts[0];
                                    const postFields = ['title', 'author', 'score', 'comments', 'url'];
                                    const missingFields = postFields.filter(field => !firstPost[field]);
                                    
                                    if (missingFields.length === 0) {
                                        validations.push('✅ 帖子字段完整');
                                    } else {
                                        validations.push(`❌ 帖子缺失字段: ${missingFields.join(', ')}`);
                                    }
                                }
                            } else {
                                validations.push('❌ 子版块结构不正确');
                            }
                        }
                    } else {
                        validations.push('❌ subreddits 数组缺失或格式错误');
                    }
                    
                    const allValid = validations.every(v => v.startsWith('✅'));
                    
                    resultDiv.innerHTML = `
                        <div class="status ${allValid ? 'success' : 'error'}">
                            ${allValid ? '✅ 数据格式验证通过！' : '⚠️ 数据格式存在问题'}
                            <ul>
                                ${validations.map(v => `<li>${v}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="status error">
                            ❌ 无法获取数据进行验证<br>
                            状态码: ${response.status}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status error">
                        ❌ 验证错误: ${error.message}
                    </div>
                `;
            }
        }

        // 页面加载时自动运行基本测试
        window.onload = function() {
            console.log('🚀 Reddit Webhook 修复测试页面已加载');
            console.log('📋 可用测试：');
            console.log('  1. 网络连接测试 - 验证webhook端点可访问性');
            console.log('  2. 数据获取测试 - 获取完整的Reddit数据');
            console.log('  3. 数据格式验证 - 验证新数据格式的完整性');
            console.log('');
            console.log('💡 建议测试顺序：连接 → 获取 → 验证');
        };
    </script>
</body>
</html>



